<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.12.2 (455489)"/><meta name="altitude" content="53.81621932983398"/><meta name="author" content="nswbmw"/><meta name="created" content="2017-10-27 12:23:14 +0000"/><meta name="latitude" content="39.97795454368859"/><meta name="longitude" content="116.4254940426691"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2017-10-28 09:52:48 +0000"/><title>第二天</title></head><body><ol><li>Node.js 核心概念</li><ol><li>单线程</li><li>异步 IO</li><ol><li>libuv(4个)</li></ol><li>事件</li><ol><li><span style="font-weight: bold;">同步</span></li><li>限制10个，2个原因</li><ol><li>源码层面用数组存当前事件的listener</li><li>callback里如果有复杂操作，如读写数据库，高并发时会引起问题</li></ol><li>扩展阅读（用来实现异步流程控制）：<a href="https://www.npmjs.com/package/eventproxy">https://www.npmjs.com/package/eventproxy</a></li></ol><li>Event Loop（基于libuv）</li><ol><li><a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/">https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/</a></li><li><a href="https://cnodejs.org/topic/57d68794cb6f605d360105bf">https://cnodejs.org/topic/57d68794cb6f605d360105bf</a></li><li>6个阶段</li><ol><li>timer: setTImeout + setInterval 的回调函数队列</li><li>io callbacks: Tcp/ Stream error的回调函数队列</li><li> idle, prepare：node 内部的，忽略</li><li> poll：（课后作业，回去仔细研究下）除了 setTImeout + setInterval + check + close阶段，其他所有的回调函数，比如：fs.readFile的回调函数</li><li><span style="white-space: pre-wrap; font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-break: break-all; word-wrap: break-word; background-color: rgb(247, 247, 247); tab-size: 4; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 22px;">check： setImmediate 的回调函数</span></li><li><span style="white-space: pre-wrap; font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-break: break-all; word-wrap: break-word; background-color: rgb(247, 247, 247); tab-size: 4; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 22px;">close callback：一些事件关闭的回调函数，比如：socket.on(‘close’, callback)</span></li></ol><li style="orphans: 2; widows: 2;"><span style="white-space: pre-wrap; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">setTimeout/setInterval 的第二个参数接收值 1~2^31-1，如果不在这个范围，默认是1</span></li><li style="orphans: 2; widows: 2;"><span style="white-space: pre-wrap;"><span style="font-size: 12px; font-family: Monaco;">setTimeout(cb, 0) 和 setImmediate 的打印结果随记，是因为机器性能问题(setTimeout回调函数是否准备好)。如果放到fs.readFile回调里，执行结果一定</span></span></li><li style="orphans: 2; widows: 2;"><span style="white-space: pre-wrap;"><span style="font-size: 12px; font-family: Monaco;">process.nextTick（不是libuv的东西，是node层面的）</span></span></li><ol><li style="orphans: 2; widows: 2;"><span style="white-space: pre-wrap;"><span style="font-size: 12px; font-family: Monaco;">macrotask(宏任务，时间循环中每一阶段) vs microtask(微任务，process.nextTick, Promise.then/catch)</span></span></li><li style="orphans: 2; widows: 2;"><span style="white-space: pre-wrap; font-size: 12px; font-family: Monaco;"><span style="font-size: 12px; font-family: Monaco; font-weight: bold;">tips:</span> process.nextTick(microtask)回调函数里调用自己也会将这个回调函数放到当前microtask末尾,可能导致死循环。setImmediate <span style="white-space: pre-wrap; font-size: 12px; font-family: Monaco;">回调函数里调用自己会将这个回调函数放到下一次事件循环，会给其他阶段回调函数执行的机会（比如：fs.readFile的回调或者setTimeout的回调）</span></span></li><li style="orphans: 2; widows: 2;"><span style="white-space: pre-wrap; font-family: Monaco;"><span style="font-family: Monaco;">microtask</span>最大长度1000</span></li></ol><li style="orphans: 2; widows: 2;"><span style="white-space: pre-wrap; font-family: Monaco;">Promise.then是microtask，Promise的构造函数是同步执行的</span></li><li style="orphans: 2; widows: 2;"><span style="white-space: pre-wrap; font-family: Monaco;">源码：</span></li><ol><li style="orphans: 2; widows: 2;"><a href="https://github.com/nodejs/node/blob/master/deps/uv/src/unix/core.c#L348">https://github.com/nodejs/node/blob/master/deps/uv/src/unix/core.c#L348</a></li></ol></ol><li>GC（程序停止）</li><ol><li>为什么分新老生代？为了提高垃圾回收的效率。</li><li>新生代（内存分配和回收频繁的区域）</li><ol><li>Scavenge算法。一分为二。64位-&gt;32MB，32位-&gt;16MB</li><li>晋升。2种情况</li><ol><li>经历过一次垃圾回收后存活，下一次垃圾回收还存活则晋升到老生代</li><li>要分配的内存大于新生代25%，则直接在老生代分配</li></ol></ol><li>老生代（内存分配和回收不频繁的区域）</li><ol><li>Mark-Sweep（标记清除）</li><li>Mark-Compact（标记整理）</li><li>三种算法比较</li><li>Mark-Compact触发条件。老生代内存不够用</li></ol><li>最大：64位-&gt;1464MB，32位-&gt;732MB</li></ol></ol><li><span style="font-family: Courier;">npm 概念及简单实用</span></li><ol><li><span style="font-family: Courier;">npm 是什么，对 Node.js 影响</span></li><ol><li><span style="font-family: Courier;">Node Packge Manager</span></li><li><span style="font-family: Courier;">促进了 Node.js 生态繁荣</span></li></ol><li><span style="font-family: Courier;">package.json（</span><a style="font-family: Courier;" href="https://docs.npmjs.com/files/package.json">https://docs.npmjs.com/files/package.json</a><span style="font-family: Courier;">）</span></li><ol><li><span style="font-family: Courier;">name不能包含中文，只能是英文+ _ + -</span></li><li><span style="font-family: Courier;">bin用来写命令行工具用</span></li><li><span style="font-family: Courier;">scripts(</span><a style="font-family: Courier;" href="https://docs.npmjs.com/misc/scripts">https://docs.npmjs.com/misc/scripts</a><span style="font-family: Courier;">)</span></li><ol><li><span style="font-family: Courier;">两种类型：</span></li><ol><li><span style="font-family: Courier;">自定义命令，比如：test-ci -&gt; npm run test-ci</span></li><li><span style="font-family: Courier;">钩子命令（</span><span style="font-family: Courier;">pre||post</span><span style="font-family: Courier;">），postinstall -&gt; npm install 后执行的命令</span></li></ol><li><span style="font-family: Courier;">test -&gt; npm run test || npm test</span></li><li><span style="font-family: Courier;">start <span style="font-family: Courier;">-&gt; npm run start || npm start</span></span></li></ol><li><span style="font-family: Courier;">dependencies(</span><a style="font-family: Courier;" href="https://docs.npmjs.com/files/package.json#dependencies">https://docs.npmjs.com/files/package.json#dependencies</a><span style="font-family: Courier;">)</span></li></ol><li><span style="font-family: Courier;">semver<a style="font-family: Courier;" href="http://semver.org/lang/zh-CN/">http://semver.org/lang/zh-CN/</a></span></li><ol><li><span style="font-family: Courier;">版本格式：主版本号.次版本号.修订号，版本号递增规则如下：</span></li><li>主版本号：当你做了不兼容的 API 修改，</li><li>次版本号：当你做了向下兼容的功能性新增，</li><li>修订号：当你做了向下兼容的问题修正。</li><li><span style="font-family: Courier;">先行版本号及版本编译信息可以加到“主版本号.次版本号.修订号”的后面，作为延伸。</span></li><li><span style="font-family: Courier;">~（</span><a style="font-family: Courier;" href="https://www.npmjs.com/package/semver#tilde-ranges-123-12-1">https://www.npmjs.com/package/semver#tilde-ranges-123-12-1</a><span style="font-family: Courier;">） vs ^（</span><a style="font-family: Courier;" href="https://www.npmjs.com/package/semver#caret-ranges-123-025-004">https://www.npmjs.com/package/semver#caret-ranges-123-025-004</a><span style="font-family: Courier;">）</span></li><li><span style="font-family: Courier;">*: 匹配最新的版本，不推荐使用</span></li><li><span style="font-family: Courier;">坑：</span></li><ol><li><span style="font-family: Courier;">修订版本号或次版本号做了不兼容修改</span></li><li><span style="font-family: Courier; font-weight: bold;">解决方法：写死版本</span></li></ol></ol></ol><li>npm 使用</li><ol><li>npm -h</li><ol><li>npm i -h</li><li>npm install/ npm i: 根据package.json安装模块，到 node_modules</li><ol><li>npm i express koa xxx：安装 express、koa等模块</li><li>npm i express —save，安装并同时写入package.json的depedences。—save-dev，同时写入devDependencies</li><li>@scope：命名空间。需要创建 org。例子：<a href="https://www.npmjs.com/package/@shimo/gulp-build">https://www.npmjs.com/package/@shimo/gulp-build</a></li><li>不能安装与当前模块重名的模块。比如当前模块叫test，那么 npm i test安装会报错</li></ol><li>npm init</li><ol><li>用来初始化一个 package.json</li><li>npm init -y 强制生成一个 packge.json</li></ol><li>npm login + npm whoami</li><li>npm ls: 查看当前目录的依赖树（跟据package.json）</li><li>npm publish:发布模块。npm publish —tag</li><ol><li>不能发布npm已有的模块（因为重名）</li><li>不能发布已有的版本号，假如当前1.1.2，不能再发布1.1.2版本</li><li>不能发布没有权限发布的模块</li><li>tip: 遵循 semver规范</li><li>不仅用来发布新模块，也用来更新模块。每次更新模块发布新版本的时候，用该命令</li><li>交替发布。可以发布低于当前版本的版本，前提是这个版本之前没有</li></ol><li>npm info xxx: npm info express：查看模块详细信息</li><li>npm run-script xxx=== npm run xxx: 执行scripts定义的命令</li><li>npm shrinkwrap!!!：（产生一个npm-shrinkwrap.json）</li><ol><li>作用：<span style="font-weight: bold;">锁定子孙模块版本号</span></li><li>运行npm i 的时候，如果有npm-shrinkwrap.json，优先使用npm-shrinkwrap.json，如果没有则使用 package.json</li></ol><li>test -&gt; npm run test || npm test</li><li>start -&gt; npm run start || npm start</li><li>npm config -&gt; 编辑 ~/.npmrc</li></ol><li>~/.npmrc: 当前用户npm全局配置（比如：registry）。模块目录下也可以有 .npmrc，只对该模块有效</li><ol><li>npm i xxx --registry=https://registry.npm.taobao.org</li></ol><li>npm uninstall: 卸载一个模块，同时从package.json 里删除</li><li>npm unpublish: <span style="font-weight: bold;">不推荐使用。下架某个版本，其他用户不能安装该版本，你也不能重新publish这个版本。为什么？安全。有个前提：1.没有被其他模块引用2.超过24小时</span></li><li>全局安装(命令行工具)</li><ol><li>加 -g 或者 —global。</li></ol></ol><li>实战：发布一个 npm 包</li><ol><li>mkdir iweb-xxx-randomjs</li><li>cd iweb-xxx-randomjs</li><li>npm init</li><li>npm i randexp —save</li><li>touch index.js(window：右键创建)</li><li>创建测试文件 test.js，修改 scripts为 “test”: “node test”</li><li>npm login（只需运行一次，后面不需要运行此命令）-&gt; npm addUser（可能需要执行） -&gt; npm publish(用 nrm 切换回 npm源)</li><li>实验一：发布1.0.2，然后再发布1.0.1。用 npm i iweb-xxx-randomjs@^1 安装 1.0.1。猜测：npm 会按时间倒序查找第一个满足该semver的版本</li><li>实验二：npm unpublish iweb-xxx-randomjs@1.0.1，然后重新 npm publish会失败，然后运行npm i iweb-xxx-randomjs@^1看看安装哪个版本，应该是1.0.2</li></ol></ol><div><br/></div><div><br/></div><div><br/></div><div>FAQ: global vs window</div><div><br/></div><div>node -&gt; global</div><div>浏览器 -&gt; window</div><div><br/></div><div>FAQ: setImmediate 前端有吗？</div><div>没有，setImmediate在check 阶段，是 libuv 实现的，浏览器不继承 libuv</div><div><br/></div><div>FAQ: 发布 1.1.3再发布 1.1.2?</div><div>见上</div><div><br/></div><div><br/></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">setTimeout</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">(</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 136); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">function</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"> timeout </span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">()</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;" /><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">{</span></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">  console</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">.</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">log</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">(</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 136, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">'timeout'</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">)</span></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">},</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 102, 102); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">0</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">)</span></div><div><br style="font-family: Menlo;"/></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">setImmediate</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">(</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 136); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">function</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"> immediate </span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">()</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;" /><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">{</span></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">  console</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">.</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">log</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">(</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 136, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">'immediate'</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">)</span></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">})</span></div><div><br/></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">——————————————————————————————————</span></div><div><br/></div><div><br/></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 136); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">var</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"> fs </span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">=</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;" /><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 136); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">require</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">(</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 136, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">'fs'</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">)</span></div><div><br style="font-family: Menlo;"/></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">fs</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">.</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">readFile</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">(</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">__filename</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">,</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;" /><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">()</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;" /><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">=&gt;</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;" /><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">{</span></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">  setTimeout</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">(()</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;" /><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">=&gt;</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;" /><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">{</span></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">    console</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">.</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">log</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">(</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 136, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">'timeout'</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">)</span></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">  </span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">},</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;" /><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 102, 102); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">0</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">)</span></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">  setImmediate</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">(()</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;" /><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">=&gt;</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;" /><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">{</span></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">    console</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">.</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">log</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">(</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 136, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">'immediate'</span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">)</span></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(0, 0, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">  </span><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">})</span></div><div><span style="font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: pre-wrap; border: 0px; color: rgb(102, 102, 0); font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">})</span></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">——————————————————————————————————</span></div><div><br/></div><div><span style="font-family: Menlo;">process.nextTick(() =&gt; {</span></div><div><span style="font-family: Menlo;">  console.log(1)</span></div><div><span style="font-family: Menlo;">})</span></div><div><span style="font-family: Menlo;">process.nextTick(() =&gt; {</span></div><div><span style="font-family: Menlo;">  console.log(2)</span></div><div><span style="font-family: Menlo;">})</span></div><div><span style="font-family: Menlo;">process.nextTick(() =&gt; {</span></div><div><span style="font-family: Menlo;">  console.log(3)</span></div><div><span style="font-family: Menlo;">})</span></div><div><span style="font-family: Menlo;">console.log(4)</span></div><div><br/></div><div>vs</div><div><br/></div><div>process.nextTick(() =&gt; {</div><div>  console.log(1)</div><div>  process.nextTick(() =&gt; {</div><div>    console.log(2)</div><div>    process.nextTick(() =&gt; {</div><div>      console.log(3)</div><div>    })</div><div>  })</div><div>})</div><div><br/></div><div>console.log(4)</div><hr/><div>process.nextTick(function tick () {</div><div>  console.log(1)</div><div>  process.nextTick(tick)</div><div>})</div><div>console.log(2)</div><div><br/></div><hr/><div><span style="font-family: Menlo;">process.nextTick(function tick () {</span></div><div><span style="font-family: Menlo;">  console.log(1)</span></div><div><span style="font-family: Menlo;">  process.nextTick(tick)</span></div><div><span style="font-family: Menlo;">})</span></div><div><br style="font-family: Menlo;"/></div><div><span style="font-family: Menlo;">setTimeout(() =&gt; {</span></div><div><span style="font-family: Menlo;">  console.log(2)//不打印</span></div><div><span style="font-family: Menlo;">}, 0)</span></div><div><br/></div><div>vs</div><div><br/></div><div>setImmediate(function tick () {</div><div>  console.log(1)</div><div>  setImmediate(tick)</div><div>})</div><div><br/></div><div>setTimeout(() =&gt; {</div><div>  console.log(2)//打印</div><div>}, 0)</div><div><span style="font-family: Menlo;">------------------------------</span></div><div><br/></div><div>setImmediate(function () {</div><div>  console.log('setImmediate1')</div><div>  setImmediate(function () {</div><div>    console.log('setImmediate2')</div><div>  })</div><div>  process.nextTick(function () {</div><div>    console.log('nextTick')</div><div>  })</div><div>})</div><div><br/></div><div>setImmediate(function () {</div><div>  console.log('setImmediate3')</div><div>})</div><hr/><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">setTimeout(() =&gt; {</span></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">  console.log(1);</span></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">}, 0);</span></div><div><br/></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">new Promise((resolve, reject) =&gt; {</span></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">  console.log(2);</span></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">  for (let i = 0; i &lt; 10000; i++) {</span></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">    i === 9999 &amp;&amp; resolve();</span></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">  }</span></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">  console.log(4);</span></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">}).then(() =&gt; {</span></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">  console.log(5);</span></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">});</span></div><div><br/></div><div><br/></div><div><span style="font-family: Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;">console.log(6);</span></div><hr/><div><span style="font-family: Menlo;">const start = Date.now()</span></div><div><br style="font-family: Menlo;"/></div><div><span style="font-family: Menlo;">setTimeout(() =&gt; {</span></div><div><span style="font-family: Menlo;">  while (Date.now() - start &lt; 10) {}</span></div><div><span style="font-family: Menlo;">  console.log(1, Date.now() - start)</span></div><div><span style="font-family: Menlo;">}, 0)</span></div><div><br style="font-family: Menlo;"/></div><div><span style="font-family: Menlo;">setTimeout(() =&gt; {</span></div><div><span style="font-family: Menlo;">  console.log(2, Date.now() - start)</span></div><div><span style="font-family: Menlo;">}, 0)</span></div><hr/><div>setImmediate(function A() {//A</div><div>  console.log(‘1');</div><div>  setTimeout(function () {</div><div>    console.log(‘2');</div><div>  }, 100);</div><div>  setImmediate(function () {</div><div>    console.log(‘3');</div><div>  });</div><div>  process.nextTick(function () {</div><div>    console.log(‘4');</div><div>  });</div><div>});</div><div>process.nextTick(function B() {//B</div><div>  console.log(‘5');</div><div>  setTimeout(function () {</div><div>    console.log(‘6');</div><div>  }, 100);</div><div>  setImmediate(function () {</div><div>    console.log(‘7');</div><div>  });</div><div>  process.nextTick(function () {</div><div>    console.log(‘8');</div><div>  });</div><div>});</div><div>console.log(‘9');</div><div>---------------------------</div><div><img src="%E7%AC%AC%E4%BA%8C%E5%A4%A9.resources/A10FCA3D-D4A8-46E0-98BC-ACD6ECA549C9.png" height="644" width="1227"/></div><div><br/></div></body></html>