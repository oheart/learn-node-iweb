<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.12.2 (455489)"/><meta name="altitude" content="53.55464553833008"/><meta name="author" content="nswbmw"/><meta name="created" content="2017-11-01 02:55:30 +0000"/><meta name="latitude" content="39.97805638222079"/><meta name="longitude" content="116.4253208923631"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2017-11-04 08:58:41 +0000"/><title>第四天</title></head><body style="zoom: 1.488007;"><div>再讲讲async方案+异步</div><div>call | apply | bind  查询api用法。MDN</div><div><ol><li>call: 第一个参数是函数this要指向的对象，第2、3、4...参数依次传入</li><li>apply: 作用跟call一样。唯一区别在于apply第二个参数接收一个数组，而不是依次传入</li><li>bind:</li><ol><li>作用1：绑定this，返回新的函数，call\apply是不返回新函数的</li><li>作用2：预传值，只需要传入剩下的值</li></ol></ol></div><div><b>强调：浏览器环境中调试代码和Node.js中不完全一样。</b></div><div><br/></div><ol><li>Node.js 常见模块的使用</li><ol><li>lodash(最常用的工具模块，回去工作中用上)</li><ol><li>可能多个方法实现相同结果</li><li>['a', 'b', 'c', ‘d’, ‘e’] -&gt; [['a', 'b'], ['c', 'd’], [‘e’]] chunk</li><li>[2, 1, 2, 1] -&gt; [2, 1] uniq</li><li>[1, [2, [3, [4, 2]], 5]] -&gt; [[1, 2], [3, 4], 5] </li><ol><li>chain。后续的方法不需要传入对应方法中第一个参数，因为链式调用的方法能拿到上一个方法的返回值。最后需要调用.value()拿到真实值</li></ol><li>[{id: 123, name: 'xxx'}, {id: 321, name: 'yyy’}] -&gt; { '123': { id: 123, name: 'xxx' }, '321': { id: 321, name: 'yyy' } }</li></ol><li>axios（http client）</li><li>cheerio（后端 jQuery，解析html字符串）</li><li>debug（最常用的日志模块(主要调试用)，可以根据环境变量开启不同类型的日志输出）</li><ol><li>作用1：可以控制不同错误等级的日志输出</li><li>作用2：可以区分不同文件日志</li><li>即：不同文件下的debug日志用来区分文件，同一文件不同的tag，区分不同类型/等级的日志</li><li><a href="https://zhuanlan.zhihu.com/p/29628849">https://zhuanlan.zhihu.com/p/29628849</a> 第二部分</li></ol><li>moment(针对处理时间的工具模块)</li><ol><li>moment.format()</li></ol><li>validator（验证用的工具模块，最新的只能处理字符串）</li><li>bluebird（重点，支持更多 Promise 写法的工具模块，用的最多的扩展 Promise用法的库）</li><ol><li>原生只有：Promise.resolve\Promise.reject\Promise.all\Promise.race</li><li>Promise.props+Promise.map….</li><li>性能优势</li></ol><li>nodemailer</li><ol><li>常用来发监控报警邮件</li><li>发邮件协议：SMTP，需要手动去邮箱开启</li><li>126/163设置：<a href="http://help.163.com/09/0219/10/52GOPOND007536NI.html">http://help.163.com/09/0219/10/52GOPOND007536NI.html</a> &amp; <a href="http://help.163.com/09/1223/14/5R7P3QI100753VB8.html">http://help.163.com/09/1223/14/5R7P3QI100753VB8.html</a></li><li>qq邮箱的pass用qq给的授权码</li><li>添加附件 <a href="https://nodemailer.com/message/attachments/">https://nodemailer.com/message/attachments/</a></li></ol><li>commander（编写命令行工具）</li></ol><li>搜索第三方模块</li><ol><li><a href="https://www.npmjs.com/search?q=xxx">https://www.npmjs.com/search?q=xxx</a></li><li><a href="http://node-modules.com/search?u=&amp;q=xxx">http://node-modules.com/search?u=&amp;q=xxx</a></li><li><a href="https://npms.io/search?q=xxx">https://npms.io/search?q=xxx</a></li><li><a href="https://github.com/search?l=JavaScript&amp;q=xxx&amp;type=Repositories&amp;utf8=%E2%9C%93">https://github.com/search?l=JavaScript&amp;q=xxx&amp;type=Repositories&amp;utf8=%E2%9C%93</a></li><li>google</li></ol><li>实战1：用 commander 编写一个天气应用(commander+axios+easy-table)</li><ol><li><a href="http://www.sojson.com/open/api/weather/json.shtml?city=%E5%8C%97%E4%BA%AC">http://www.sojson.com/open/api/weather/json.shtml?city=%E5%8C%97%E4%BA%AC</a></li><li>实现效果：tianqi --city=北京 打印出好看的当前城市天气</li><li>转成命令行工具</li><ol><li>package.json（<a href="https://docs.npmjs.com/files/package.json#bin">https://docs.npmjs.com/files/package.json#bin</a>） -&gt; “bin": { “tianqi”: “./index” }</li><li>index.js -&gt; index</li><li>index 文件最开头添加shell bang：#!/usr/bin/env node</li><li>npm publish，然后 npm i xxx -g 使用<br/></li></ol></ol><li>实战2：</li><ol><li>定时抓彩票脚本，实现每天给自己发邮件，报告昨天开奖信息(cron+axios+cheerio+nodemailer)</li></ol></ol><div><br/></div><div>—————lodash</div><div>var _ = require('lodash')</div><div><br/></div><div>console.log(_.chunk(['a', 'b', 'c', 'd', 'e'], 2))</div><div>console.log(_.uniq([2, 1, 2, 1]))</div><div><br/></div><div>console.log(_.chunk(_.uniq(_.flattenDeep([1, [2, [3, [4, 2]], 5]]))))</div><div><br/></div><div>console.log(</div><div>  _.chain([1, [2, [3, [4, 2]], 5]])</div><div>   .flattenDeep()</div><div>   .uniq()</div><div>   .chunk(2)</div><div>   .value()</div><div>)</div><div><br/></div><div>console.log(</div><div>  _([1, [2, [3, [4, 2]], 5]])</div><div>   .flattenDeep()</div><div>   .uniq()</div><div>   .chunk(2)</div><div>   .value()</div><div>)</div><div><br/></div><div>var a = [</div><div>  {id: 123, name: 'xxx'},</div><div>  {id: 321, name: 'yyy'}</div><div>]</div><div>console.log(_.keyBy(a, 'id'))</div><div>console.log(_.reduce(a, function (obj, value, key) {</div><div>  obj[value.id] = value</div><div>  return obj</div><div>}, {}))</div><div><br/></div><div>—————debug</div><div>const normalLog = require('debug')('log')</div><div>const errorLowLog = require('debug')('error:low')</div><div>const errorNormalLog = require('debug')('error:normal')</div><div>const errorHighLog = require('debug')('error:high')</div><div><br/></div><div>setInterval(() =&gt; {</div><div>  const value = Math.random()</div><div>  switch (true) {</div><div>    case value &lt; 0.5: normalLog(value); break</div><div>    case value &gt;= 0.5 &amp;&amp; value &lt; 0.7: errorLowLog(value); break</div><div>    case value &gt;= 0.7 &amp;&amp; value &lt; 0.9: errorNormalLog(value); break</div><div>    case value &gt;= 0.9: errorHighLog(value); break</div><div>    default: normalLog(value)</div><div>  }</div><div>}, 1000)</div><div><br/></div><div>三个点：</div><div><ol><li>,用法</li><li>*用法</li><li>-用法</li></ol></div><div>DEBUG=log node app.js -&gt; 只打印特定tag的日志，这里是 log</div><div>DEBUG=log,error:low node app.js -&gt; 用逗号分隔，打印 log 和 error:low的日志</div><div>DEBUG=error:* node app.js -&gt; 打印所有 error 类型日志</div><div>DEBUG=* node app.js -&gt; 打印所有日志</div><div><br/></div><div>———————moment</div><div>var moment = require('moment')</div><div><br/></div><div>// 2017-11-04 10:57:20</div><div>console.log(moment().format('YYYY-MM-DD HH:mm:ss'))</div><div>// 2017-11-4 11:9:01</div><div>console.log(moment().format('YYYY-MM-D HH:m:ss'))</div><div>// 2017-11-04 11:10:02</div><div>console.log(moment().format('YYYY-MM-DD HH:m:ss’))</div><div><br/></div><div>———————validator</div><div>var validator = require('validator')</div><div><br/></div><div>console.log(validator.isEmail('<a href="mailto:foo@bar.com">foo@bar.com</a>'))</div><div>console.log(validator.isEmail('<a href="http://foobar.com">foobar.com</a>'))</div><div>console.log(validator.isIP('1.1.1.1'))</div><div>console.log(validator.isIP('1.1.1.1.1'))</div><div>console.log(validator.isNumeric('1'))</div><div>console.log(validator.isNumeric('1a'))</div><div>console.log(validator.isNumeric('0x1'))</div><div><br/></div><div><br/></div><div>—————————bluebird</div><div>// 返回</div><div>// {</div><div>//   'a.txt': a.txt的内容,</div><div>//   'b.txt': b.txt的内容</div><div>// }</div><div><br/></div><div>var fs = require('fs')</div><div>var readFilePromise = require('util').promisify(fs.readFile)</div><div><br/></div><div>// var obj = {}</div><div>// Promise.all([</div><div>//   readFilePromise('./a.txt'),</div><div>//   readFilePromise('./b.txt')</div><div>// ]).then(arr =&gt; {</div><div>//   obj['a.txt'] = arr[0]</div><div>//   obj['b.txt'] = arr[1]</div><div><br/></div><div>//   console.log(obj)</div><div>// })</div><div><br/></div><div>var bluebird = require('bluebird')</div><div><br/></div><div>bluebird.props({</div><div>  'a.txt': readFilePromise('./a.txt'),</div><div>  'b.txt': readFilePromise('./b.txt')</div><div>}).then(console.log)</div><div><br/></div><div>// bluebird.map(arr, fn) &lt;=&gt; Promise.all(arr.map(fn))</div><div>————————nodemailer</div><div>var nodemailer = require('nodemailer')</div><div><br/></div><div>transporter = nodemailer.createTransport({</div><div>  host: '<a href="http://smtp.163.com">smtp.163.com</a>',</div><div>  port: 25,</div><div>  auth: {</div><div>    user: '<a href="mailto:xxx@163.com">xxx@163.com</a>',</div><div>    pass: 'xxx'  // 填qq的授权码_在开启 smtp 模式的时候</div><div>  }</div><div>})</div><div><br/></div><div>transporter.sendMail({</div><div>  from: '<a href="mailto:xxx@163.com">xxx@163.com</a>',</div><div>  to: '<a href="mailto:xxx@qq.com">xxx@qq.com</a>',</div><div>  subject: 'test nodemailer',</div><div>  text: 'test nodemailer!!!',</div><div>}, (error, info) =&gt; {</div><div>  console.log(error, info);</div><div>})</div><div><br/></div><div>——————call</div><div>var person = {</div><div>  name: 'nswbmw'</div><div>}</div><div>global.name = 'haha'</div><div>function sayName() {</div><div>  console.log(this.name)</div><div>}</div><div><br/></div><div>sayName()</div><div>sayName.call(person)</div><div><br/></div><div><br/></div><div>var person = {</div><div>  name: 'nswbmw'</div><div>}</div><div>global.name = 'haha'</div><div>function sayName(prefix, suffix) {</div><div>  console.log(prefix + this.name + suffix)</div><div>}</div><div><br/></div><div>sayName('Hi, ', '!!!')</div><div>sayName.call(person, 'Hi, ', '!!!')</div><div>------------——apply</div><div>var person = {</div><div>  name: 'nswbmw'</div><div>}</div><div>global.name = 'haha'</div><div>function sayName(prefix, suffix) {</div><div>  console.log(prefix + this.name + suffix)</div><div>}</div><div><br/></div><div>sayName('Hi, ', '!!!')</div><div>sayName.call(person, 'Hi, ', '!!!')</div><div>sayName.apply(person, ['Hi, ', '!!!’])</div><div><br/></div><div>————————————bind</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></body></html>