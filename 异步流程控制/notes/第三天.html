<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.12.2 (455489)"/><meta name="altitude" content="53.43419647216797"/><meta name="author" content="nswbmw"/><meta name="created" content="2017-10-28 12:40:05 +0000"/><meta name="latitude" content="39.97793841096718"/><meta name="longitude" content="116.4254790482188"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2017-10-29 08:42:49 +0000"/><title>第三天</title></head><body style="zoom: 1.75;"><ol><li>异步流程控制</li><ol><li>Callback</li><ol><li>error first</li></ol><li>Promise(为了解决callback hell的问题)</li><ol><li><a href="https://zhuanlan.zhihu.com/p/25178630">https://zhuanlan.zhihu.com/p/25178630</a></li><li>Promise用法</li><ol><li>可以通过 new Promise(function (resolve, reject) {}) 生成一个 promise</li><li>promise 可以通过调用 .then方法返回promise的结果，then 的第一个参数是处理正确时的返回值的函数，第二个参数是处理错误时的返回的error的函数</li><li>在Promise构造函数里throw一个error，相当于 reject(error)</li><li>promise.catch也可以捕获promise返回的错误</li><li>tips: 直接在类（或构造函数）上调用的方法叫静态方法，在类（或构造函数）的实例上调用的方法叫实例方法</li><li>Promise.resolve 是将一个值包裹成 promise对象，状态是fulfilled,Promise.resolve('haha')等价于new Promise(function (resolve, reject) {resolve('haha')})</li><ol><li>Promise.resolve和Promise.reject完全可以被Promise构造函数用法替代，是一个简单方法</li></ol><li>Promise.reject 也是将一个值包裹成 promise对象，只不过状态是 rejected</li><li><b>promise的 then和catch都是可以链式调用的，下一个then的值是上一个promise变成fulfilled的返回值（返回值可以是promise,也可以是任意值(这个任意值内部是把它包装成promise)。如果是promise，会等待该promise返回(状态变更)）,见代码9</b></li><li><b>tips: 区分链式调用then和并行调用then的区别。</b></li></ol><li>Promise A+规范：</li><ol><li>官方文档：<a href="https://promisesaplus.com/">https://promisesaplus.com/</a> </li><li>中文翻译：<a href="https://segmentfault.com/a/1190000002452115">h</a><a style="color: rgb(0, 0, 238); text-decoration: underline;" href="http://www.ituring.com.cn/article/66566">http://www.ituring.com.cn/article/66566</a></li></ol><li>3 种状态：pending（初始状态），<span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: -apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">fulfilled，<span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: -apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">rejected</span></span></li><ol><li style="orphans: 2; widows: 2;"><font style="font-family: -apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif; color: rgb(51, 51, 51);">状态转化：<span style="font-family: -apple-system; color: rgb(51, 51, 51);">pending-&gt;<span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: -apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">fulfilled或者<span style="font-family: -apple-system; color: rgb(51, 51, 51);">pending-&gt;<span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: -apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">rejected。没有其他情况。</span></span></span></span></font></li></ol><li>构造函数同步执行，见代码1</li><li>then 方法可以被同一个 promise 调用多次，见代码2</li><ol><li>原理在于：第一次调用之前，状态就已经从pengding-&gt;fulfilled，同时内部保留了一个值，这时多次调用.then，都会返回内部的那个值</li></ol><li>promise抛错(rejected)，则跳过then,被最近的一个catch捕获（前提是：1.then没有第二个处理错误的函数 2.最近的catch没有值穿透），见代码3</li><ol><li>结论：在then/catch里throw new Error(xxx)等价于return Promise.reject(xxx)</li></ol><li>构造函数resolve 或 reject 只执行一次，多次调用没有任何作用，见代码4</li><ol><li><b>UnhandledPromiseRejectionWarning警告：rejected状态的promise没有捕获错误的处理函数，或者说没有处理错误的逻辑。</b></li></ol><li>then返回的值不能是 promise 本身，否则会造成死循环，见代码5</li><ol><li>原因：then里返回的promise会等待他状态改变（或者说执行完）才会进入到下一个then</li></ol><li>值穿透，见代码6</li><ol><li>then的参数正常情况下使用接收函数，如果传递一个非函数，则忽略，下一个then使用的是当前then的上一个返回值，也就是会跳过这个then</li></ol><li>then 的第二个参数 vs catch，见代码7</li><ol><li>.then里第二个处理错误的回调函数不会捕获这个then第一个处理成功时的回调函数抛出的error</li><li>then/catch里没有return值等价于return Promise.resolve(undefined)</li></ol><li>Promise.all vs Promise.race，见代码8</li><li>callback &lt;-&gt; Promise</li><ol><li>callback 和 promise 可以相互转化（见代码10）</li></ol><li>分析<a href="https://zhuanlan.zhihu.com/p/25198178">https://zhuanlan.zhihu.com/p/25198178</a></li><li><span>util核心模块：util.callbackify(original)  + <span>util.promisify(original)</span></span></li></ol><li>Generator + co</li><ol><li>yield只能在 generateFunction(function*)中使用</li><li>yield 在 co 中后面可以是：function, promise, generator, array, or object</li><li>tips: es6中yield 后是可以跟任意值的。但co对此作了限制。</li><li>co的用法</li><li>课后作业：回去看一下genenrator的用法，有兴趣的在看一下co的实现，网上有很多相关的文章。</li></ol><li>async + await（需要node@8以上）</li><ol><li>async执行返回 promise</li><li>await 只能在 async 函数中使用</li><li>await 值不是一个 promise，await 会把该值转换为已正常处理的Promise。即await后面跟的没有限制，而 co 中，yield 有限制</li></ol></ol><li>实战：实现文件内容拼接的3种方式（callback+promise+async/await）</li><li>结论：async/await + Promise 最好用</li></ol><div><br/></div><div><br/></div><div>———————代码0</div><div>var promise = new Promise(function (resolve, reject) {</div><div>  // setTimeout(function () {</div><div>  //   resolve('haha')</div><div>  // }, 1000)</div><div>  setTimeout(function () {</div><div>    reject(new Error('hehe'))</div><div>  }, 1000)</div><div>})</div><div>console.log(promise)</div><div>// promise.then(function (res) {</div><div>//   console.log(promise)</div><div>//   console.log(res)</div><div>// })</div><div>promise.catch(function (res) {</div><div>  console.log(promise)</div><div>  console.log(res)</div><div>})</div><div><br/></div><div>——————代码1</div><div>var promise = new Promise((resolve, reject) =&gt; {</div><div>  console.log(1)</div><div>  resolve('haha')</div><div>})</div><div>console.log(2)</div><div><br/></div><div>——————代码2</div><div>var promise = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    resolve('haha')</div><div>  }, 1000)</div><div>})</div><div><br/></div><div>var start = Date.now()</div><div>promise.then((res) =&gt; {</div><div>  console.log(res, Date.now() - start)</div><div>})</div><div>promise.then((res) =&gt; {</div><div>  console.log(res, Date.now() - start)</div><div>})</div><div>promise.then((res) =&gt; {</div><div>  console.log(res, Date.now() - start)</div><div>})</div><div>——————代码3</div><div>Promise.resolve()</div><div>  .then(() =&gt; {</div><div>    throw new Error('error!!!')</div><div>  })</div><div>  .then((res) =&gt; {</div><div>    console.log(1, res)</div><div>  })</div><div>  .catch((e) =&gt; {</div><div>    console.error(2, e)</div><div>  })</div><div><br/></div><div>Promise.resolve()</div><div>  .then(() =&gt; {</div><div>    // return new Error('error!!!') // 会打印1！！！！</div><div>    return Promise.reject(new Error('error!!!'))</div><div>  })</div><div>  .then((res) =&gt; {</div><div>    console.log(1, res)</div><div>  })</div><div>  .catch((e) =&gt; {</div><div>    console.error(2, e)</div><div>  })</div><div>——————代码4</div><div>var promise = new Promise((resolve, reject) =&gt; {</div><div>  resolve('haha1')</div><div>  resolve('haha2')</div><div>  resolve('haha3')</div><div>})</div><div><br/></div><div>promise.then((res) =&gt; {</div><div>  console.log(res)</div><div>})</div><div><br/></div><div><br/></div><div>var promise = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    resolve('haha')</div><div>  }, 1000)</div><div>  reject('error')</div><div>})</div><div><br/></div><div>var start = Date.now()</div><div>promise.then(() =&gt; {</div><div>  console.log('then', Date.now() - start)</div><div>})</div><div>promise.catch((e) =&gt; {</div><div>  console.error(e)</div><div>  console.error('catch', Date.now() - start)</div><div>})</div><div>——————代码5</div><div><br/></div><div>var promise = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    resolve('haha')</div><div>  }, 1000)</div><div>})</div><div>var a = promise.then(() =&gt; {</div><div>  return a</div><div>})</div><div><br/></div><div>a</div><div>  .then(console.log)</div><div>  .catch(console.error)</div><div><br/></div><div>————————代码6</div><div>var promise = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    resolve('haha')</div><div>  }, 1000)</div><div>})</div><div>promise</div><div>  .then(1)</div><div>  .then('hehe')</div><div>  // .then(console.log)</div><div>  // .then(console.log)</div><div>  .then((res) =&gt; {</div><div>    return console.log(res)</div><div>  })</div><div>  .then((res) =&gt; {</div><div>    return console.log(res)</div><div>  })</div><div><br/></div><div><br/></div><div>var promise2 = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    reject('haha')</div><div>  }, 1000)</div><div>})</div><div>promise2</div><div>  .catch(1)</div><div>  .catch('hehe')</div><div>  .catch((error) =&gt; {</div><div>    return console.log(1, error)</div><div>  })</div><div>  .catch((error) =&gt; {</div><div>    return console.log(2, error)</div><div>  })</div><div><br/></div><div>—————————代码7</div><div>var promise = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    resolve('haha')</div><div>  }, 1000)</div><div>})</div><div><br/></div><div>promise</div><div>  .then(function success(res) {</div><div>    throw new Error('error')</div><div>  }, function fail1(e) {</div><div>    console.error(1, e)</div><div>  })</div><div>  .catch(function fail2(e) {</div><div>    console.error(2, e)</div><div>  })</div><div><br/></div><div>——————————代码8</div><div>var promise1 = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    resolve('haha')</div><div>  }, 1000)</div><div>})</div><div><br/></div><div>var promise2 = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    resolve('hehe')</div><div>  }, 2000)</div><div>})</div><div><br/></div><div>var start = Date.now()</div><div>Promise.all([promise1, promise2, 1, '???'])</div><div>  .then((res) =&gt; {</div><div>    console.log(Date.now() - start)</div><div>    console.log(res)</div><div>  })</div><div><br/></div><div>Promise.race([promise1, promise2])</div><div>  .then((res) =&gt; {</div><div>    console.log(Date.now() - start)</div><div>    console.log(res)</div><div>  })</div><div><br/></div><div>Promise.race([promise1, promise2, 1, '???'])</div><div>  .then((res) =&gt; {</div><div>    console.log(Date.now() - start)</div><div>    console.log(res)</div><div>  })</div><div><br/></div><div><br/></div><div>————————代码9</div><div>var promise = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    resolve('haha')</div><div>  }, 1000)</div><div>})</div><div><br/></div><div>var start = Date.now()</div><div>promise</div><div>  .then((res) =&gt; {</div><div>    console.log(res, Date.now() - start)</div><div>  })</div><div>  .then((res) =&gt; {</div><div>    console.log(res, Date.now() - start)</div><div>  })</div><div>  .then((res) =&gt; {</div><div>    console.log(res, Date.now() - start)</div><div>  })</div><div><br/></div><div><br/></div><div><br/></div><div>var promise = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    resolve('haha')</div><div>  }, 1000)</div><div>})</div><div><br/></div><div>var promis2 = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    resolve('hehe')</div><div>  }, 2000)</div><div>})</div><div><br/></div><div>var start = Date.now()</div><div>promise</div><div>  .then((res) =&gt; {</div><div>    console.log(res, Date.now() - start)</div><div>  })</div><div>  .then((res) =&gt; {</div><div>    console.log(res, Date.now() - start)</div><div>    return promis2</div><div>  })</div><div>  .then((res) =&gt; {</div><div>    console.log(res, Date.now() - start)</div><div>  })</div><div><br/></div><div><br/></div><div><br/></div><div>var promise = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    resolve('haha')</div><div>  }, 1000)</div><div>})</div><div><br/></div><div>var promis2 = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    resolve('hehe')</div><div>  }, 2000)</div><div>})</div><div><br/></div><div>var start = Date.now()</div><div>promise.then((res) =&gt; {</div><div>  console.log(res, Date.now() - start)</div><div>})</div><div>promise.then((res) =&gt; {</div><div>  console.log(res, Date.now() - start)</div><div>  return promis2</div><div>}).then(() =&gt; {})</div><div>promise.then((res) =&gt; {</div><div>  console.log(res, Date.now() - start)</div><div>})</div><div><br/></div><div><br/></div><div><br/></div><div>var promise = new Promise((resolve, reject) =&gt; {</div><div>  setTimeout(() =&gt; {</div><div>    resolve('haha')</div><div>  }, 1000)</div><div>})</div><div><br/></div><div>var start = Date.now()</div><div>promise</div><div>  .then((res) =&gt; {</div><div>    console.log(res, Date.now() - start)</div><div>  })</div><div>  .then((res) =&gt; {</div><div>    console.log(res, Date.now() - start)</div><div>    return new Promise((resolve, reject) =&gt; {</div><div>      setTimeout(() =&gt; {</div><div>        resolve('hehe')</div><div>      }, 2000)</div><div>    })</div><div>  })</div><div>  .then((res) =&gt; {</div><div>    console.log(res, Date.now() - start)</div><div>  })</div><div>———————代码10</div><div>var fs = require('fs')</div><div><br/></div><div>function readFileCallback(filename, callback) {</div><div>  fs.readFile(filename, (err, content) =&gt; {</div><div>    if (err) {</div><div>      callback(err)</div><div>    } else {</div><div>      callback(null, content.toString())</div><div>    }</div><div>  })</div><div>}</div><div><br/></div><div>function readFilePromise(filename) {</div><div>  return new Promise((resolve, reject) =&gt; {</div><div>    fs.readFile(filename, (err, content) =&gt; {</div><div>      if (err) {</div><div>        reject(err)</div><div>      } else {</div><div>        resolve(content.toString())</div><div>      }</div><div>    })</div><div>  })</div><div>}</div><div><br/></div><div>//要求：里面用到 readFilePromise</div><div>function readFilePromiseToCallback(filename, callback) {</div><div>  readFilePromise(filename)</div><div>    .then((content) =&gt; {</div><div>      callback(null, content)</div><div>    })</div><div>    .catch((err) =&gt; {</div><div>      callback(err)</div><div>    })</div><div>  // readFilePromise(filename)</div><div>  //   .then((content) =&gt; {</div><div>  //     callback(null, content)</div><div>  //   }, (err) =&gt; {</div><div>  //     callback(err)</div><div>  //   })</div><div>}</div><div><br/></div><div>// 测试</div><div>readFilePromiseToCallback('./haha.txt', (err, content) =&gt; {</div><div>  console.log(err, content)</div><div>})</div><div><br/></div><div>readFilePromiseToCallback('./haha1.txt', (err, content) =&gt; {</div><div>  console.log(err, content)</div><div>})</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>// readFileCallback('./haha.txt', (err, content) =&gt; {</div><div>//   console.log(err, content)</div><div>// })</div><div><br/></div><div>// readFilePromise('./haha.txt')</div><div>//   .then((content) =&gt; {</div><div>//     console.log(content)</div><div>//   })</div><div>//   .catch((err) =&gt; {</div><div>//     console.error(err)</div><div>//   })</div><div><br/></div><div>————————————实战</div><div>// 最终结果：拼接a.txt,b.txt,c.txt，打印出 abc</div><div>var fs = require('fs')</div><div><br/></div><div>// callback</div><div>fs.readFile('./a.txt', function (err, aContent) {</div><div>    if (err) {</div><div>        console.error(err)</div><div>        return</div><div>    }</div><div>    fs.readFile('./b.txt', function (err, bContent) {</div><div>        if (err) {</div><div>            console.error(err)</div><div>            return</div><div>        }</div><div>        fs.readFile('./c.txt', function (err, cContent) {</div><div>            if (err) {</div><div>                console.error(err)</div><div>                return</div><div>            }</div><div>            console.log(aContent + bContent + cContent)</div><div>        })</div><div>    })</div><div>})</div><div><br/></div><div>// promise</div><div>// 方法1</div><div>function readFilePromise(filename) {</div><div>  return new Promise((resolve, reject) =&gt; {</div><div>    fs.readFile(filename, (err, content) =&gt; {</div><div>      if (err) {</div><div>        reject(err)</div><div>      } else {</div><div>        resolve(content.toString())</div><div>      }</div><div>    })</div><div>  })</div><div>}</div><div><br/></div><div>readFilePromise('./a.txt').then((aContent) =&gt; {</div><div>    readFilePromise('./b.txt').then((bContent) =&gt; {</div><div>        readFilePromise('./c.txt').then((cContent) =&gt; {</div><div>            console.log(aContent + bContent + cContent)</div><div>        })</div><div>    })</div><div>})</div><div><br/></div><div>// 方法2</div><div>var content = ''</div><div>readFilePromise('./a.txt')</div><div>    .then((aContent) =&gt; {</div><div>        content += aContent</div><div>        return readFilePromise('./b.txt')</div><div>    })</div><div>    .then((bContent) =&gt; {</div><div>        content += bContent</div><div>        return readFilePromise('./c.txt')</div><div>    })</div><div>    .then((cContent) =&gt; {</div><div>        content += cContent</div><div>        console.log(content)</div><div>    })</div><div><br/></div><div>// 方法3 Promise.all。优点：1.代码少 2.速度快</div><div>Promise.all([readFilePromise('./a.txt'), readFilePromise('./b.txt'), readFilePromise('./c.txt')])</div><div>    .then((contents) =&gt; {</div><div>        console.log(contents.join(''))</div><div>    })</div><div><br/></div><div>// 方法4。优化 readFilePromise</div><div>var readFilePromise2 = require('util').promisify(fs.readFile)</div><div>Promise.all([readFilePromise2('./a.txt'), readFilePromise2('./b.txt'), readFilePromise2('./c.txt')])</div><div>    .then((contents) =&gt; {</div><div>        console.log(contents.join(''))</div><div>    })</div><div><br/></div><div>// async方案1</div><div>var fs = require('fs')</div><div>var readFilePromise3 = require('util').promisify(fs.readFile)</div><div><br/></div><div>async function readFileAsync () {</div><div>    var aContent = await readFilePromise3('./a.txt')</div><div>    var bContent = await readFilePromise3('./b.txt')</div><div>    var cContent = await readFilePromise3('./c.txt')</div><div>    console.log(aContent + bContent + cContent)</div><div>}</div><div><br/></div><div>readFileAsync()</div><div><br/></div><div>// async方案2</div><div>Promise.all</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>FAQ1 什么时候用 Promise.resolve 或者 new Promise?</div><div>Promise.resolve 是 new Promise的方便写法，new Promise可以替代 Promise.resolve/reject，但是反过来不可以。</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></body></html>