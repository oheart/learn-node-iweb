<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.12.2 (455489)"/><meta name="altitude" content="53.68698883056641"/><meta name="author" content="nswbmw"/><meta name="created" content="2017-11-04 15:51:55 +0000"/><meta name="latitude" content="39.97800158221618"/><meta name="longitude" content="116.4254419789786"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2017-11-05 09:28:31 +0000"/><title>第五天</title></head><body style="zoom: 1.5;"><div>作业：</div><div><ol><li>熟悉 mongodb <a href="http://www.runoob.com/mongodb/mongodb-insert.html">http://www.runoob.com/mongodb/mongodb-insert.html</a></li><li>温故 express</li></ol></div><div><br/></div><ol><li>Express(Node.js 最流行的web框架)</li><ol><li>HTTP 基础(<a href="http://www.ruanyifeng.com/blog/2016/08/http.html">http://www.ruanyifeng.com/blog/2016/08/http.html</a>)</li><ol><li>《图解 TCP/IP》</li><li>请求方法|动作（<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods</a>）</li><ol><li>比如：GET、POST、PUT、DELETE、PATCH、OPTIONS</li><ol><li>post\patch\put的语义上的区别：post创建、put是用来覆盖更新、patch用来部分更新</li></ol></ol><li>Headers（<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers</a>）存储了一些请求信息或者返回的响应信息</li><ol><li>Content-Type（<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types">https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types</a>）</li><ol><li>客户端带上 content-type，服务端收到后根据 content-type不同返回不同格式的响应体(body)</li><li>常用：</li><li>text/html  html页面、text/plain 纯文本、image/jpeg image/png图片、application/json JSON、application/xml  XML</li><li>演示见代码1</li></ol><li><a title="The Cookie HTTP request header contains stored HTTP cookies previously sent by the server with the Set-Cookie header." href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cookie">Cookie</a>：存储一些简单的用户信息</li><li>Accept vs Conent-Type：Accept表示接收什么格式，Conent-Type表示发送的什么格式、</li><li>Connection:keep-alive。http1.1 之前一个请求到来到创建一个连接，返回后销毁这个连接。http1.1加入了Connection:keep-alive，每个浏览器访问该页面时会维持这个连接，复用连接。HTTP 协议是基于 TCP 协议之上的。</li></ol><li>状态码及含义（<a href="https://httpstatuses.com/">https://httpstatuses.com/</a> or <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status</a>）</li><ol><li>200 成功+响应体</li><li>204 成功，但是没有响应体</li><li>301 重定向，资源永久转移</li><li>302 重定向，临时</li><li>304，没有修改</li><li>400，请求参数错误</li><li>401，未授权的，需要登录。</li><li>403，禁止的。登录了，但没有权限。比如：非管理员想进行管理员的操作</li><li>404，请求的url/资源不存在</li><li>500，服务器错误</li><li>502，网关错误。这个通常是 Nginx或 Apache返回的。比如：服务需要停机升级，前面的网关可以设置 502 直接返回，而不会落到后端</li><li>504，请求超时</li></ol></ol><li>postman/DHC chrome插件</li><li>Express 基础</li><ol><li>封装的  http 模块，提供了一些设计方法和 api，类比 JQuery 和原生操作 DOM的方法</li><li>hello, world</li><ol><li>express 的 req 对象是封装的 http 的 req 对象， res 同理</li><li>res.send 会根据返回的body去设置 content-type，res.end 也会自动判断并设置content-type但可以修改，其他用法相当于 http 模块的 res.end</li><li>动手测验：下载文件</li><ol><li>方法1：res.attachment(‘文件名')+res.end(内容'')</li><li>方案2：res.download(‘xxx’)-&gt;推荐</li></ol></ol></ol><li>中间件</li><ol><li>中间件模型：请求到来依次经过设置的中间件做些处理，最后处理完返回响应给客户端</li><li>use用来加载中间件，中间件第三个参数是 next，调用 next() 后才会将请求传递到下一个中间件。</li><li>中间件分为：应用级中间件和路由级中间件。见代码</li><li>中间件里可以提前返回，调用类似 res.end() 等返回响应的api。</li><li>顺序，见代码</li></ol><li>路由(作用就是根据用户请求的不同的url，处理不同的逻辑，然后返回不同的数据)</li><ol><li>访问：<a href="http://localhost:3000/haha/hehe?name=xxx">http://localhost:3000/haha/hehe?name=xxx</a></li><ol><li>req.originalUrl -&gt; /haha/hehe?name=xxx</li><li>req.path -&gt; /haha/hehe</li><li>req.headers -&gt; 请求头信息</li><li>req.query -&gt; 解析 url 中 querystring 后的对象，如{ name: 'xxx’ }</li><li>req.params -&gt; 是路由中定义的占位符</li><li>req.body -&gt; 解析后的请求体</li></ol><li>404，见代码</li><li><a href="http://expressjs.com/en/guide/routing.html">http://expressjs.com/en/guide/routing.html</a></li><li>:代表占位符，* 代表匹配后续所有url，? 代表问号前一个字符可能有也可能没有，+代表前一个字符有一到多个</li><li>req.query vs req.params vs req.body(需要引入body-parser)</li><li>express.Router() <a href="http://expressjs.com/en/guide/routing.html">http://expressjs.com/en/guide/routing.html</a></li><ol><li>作用：把不同逻辑的路由拆到不同的路由文件里</li></ol></ol><li>模板引擎</li><ol><li>怎么用：模板+数据=页面</li><ol><li>&lt;%= xxx %&gt;，结合数据生成字符串，如果有 html 标签，则转义</li><li>&lt;%- xxx %&gt;，结合数据生成字符串，不转义</li><li>&lt;% xxx %&gt;，xxx是js语法/表达式，标签需要闭合/成对，不返回值</li></ol><li>ejs <a href="https://github.com/mde/ejs">https://github.com/mde/ejs</a></li></ol><li>错误处理</li><ol><li>next 可以接收一个错误对象，如果是next()，会执行到后面的中间件，如果是 next(error)，不会执行到后面的中间件，会调到 error handler（错误处理函数）</li><li>express内置了一个错误处理函数（返回错误栈eroor.stack）,我们可以自定义错误处理函数</li><li>自定义错误处理函数一定要放到所有路由后面</li></ol><li>静态资源</li></ol><li>MongoDB</li><ol><li>《MongoDB 权威指南》最新版</li><li>MongoDB 是什么(NoSQL)</li><ol><li>与传统 SQL 区别</li><ol><li>概念上：SQL-&gt;database，MongoDB-&gt;database。SQL-&gt;table，MongoDB-&gt;collection(集合)。SQL-&gt;row，MongoDB-&gt;field（字段）。</li><li>使用上：SQL使用 sql 语句查询，比如：select * from xxx。MongoDB写法更接近 js 语法。</li></ol><li>BSON(<span>BSON（）是一种类</span><a href="https://baike.baidu.com/item/json">json</a><span>的一种二进制形式的存储格式，简称Binary JSON，它和JSON一样，支持内嵌的文档对象和数组对象，但是BSON有JSON没有的一些数据类型，如Date和BinData类型。</span>)</li></ol><li>MongoDB 的安装<br/></li><li>MongoDB 的使用</li><ol><li>启动。到 MongoDB 的目录(类似于 mongodb/server/3.4)下，创建 db 文件夹，用来指定MongoDB存储的数据。使用 ./bin/mongod --dbpath=db（cmd: .\bin\mongod --dbpath=db） 启动。</li><li>运行 ./bin/mongo</li><li>show databases || show dbs -&gt; 列出当前所有的数据库</li><li>use iweb-&gt; use 用来切换到 iweb数据库，此时iweb还未创建</li><li>db.users.insert({name: 'zhangsan’}) + db.users.insert({name:'zhangsan'}) -&gt;此时创建了iweb数据库和users集合</li><li>show dbs -&gt; show collections || show tables</li><li>db -&gt; 打印当前所在数据库</li><li>db.user.find() -&gt; find 用来查找所有满足条件的文档</li><li>db.users.find({name: "zhangsan”}) -&gt; 只返回一条 name 是 zhangsan 的</li><li>db.users.findOne({xxx})</li><li>db.users.update({需要满足的条件}, {需要更新的内容})</li><ol><li>db.users.update({name: ’nswbmw’}, {age: 18}) 这样会覆盖</li><li>db.users.update({age: 18},{ $set: { name: 'nswbmw' } }) 不会覆盖原有文档</li></ol><li>db.users.remove({name: 'zhangsan’})</li><li>$set, $in, $gt, $lt….</li><ol><li>$in -&gt; db.users.remove({name: { $in: [‘zhangsan’, ‘lisi'] }})</li></ol></ol><li>扩展</li><ol><li>_id(ObjectId 生成规则)</li><ol><li><span>ObjectId 采用12字节的存储空间，每个字节两位16进制数字，是一个24位的字符串。</span></li><li><span>ObjectId 是 node.js 的 sdk/client 生成的，而不是 mongodb 生成的</span></li><li><img src="%E7%AC%AC%E4%BA%94%E5%A4%A9.resources/EDE19AC9-CF2A-483D-A8CF-9629261359EC.png" height="185" width="793"/></li><li><span>4字节：UNIX时间戳 </span></li><li><span>3字节：表示运行MongoDB的机器码</span></li><li><span>2字节：表示生成此_id的进程 （node/Java/PHP...）</span></li><li><span>3字节：由一个随机数开始的计数器生成的值 </span></li><li>为什么 ObjectId放到sdk去生成？因为 ObjectId生成耗性能</li></ol><li>16MB 限制与 GridFS</li><ol><li>一个文档（document）最大是 16MB</li><li>存储大文件用 GridFS(会把大文件分块)</li></ol><li>GUI</li></ol><li>菜鸟教程。<a href="http://www.runoob.com/mongodb/mongodb-insert.html">http://www.runoob.com/mongodb/mongodb-insert.html</a></li></ol></ol><div><br/></div><div><br/></div><div>FAQ: Accept-Language的q（权重）为什么没有 1 ？</div><div><br/></div><div><br/></div><div>——————————代码1</div><div>const http = require('http');</div><div><br/></div><div>const html = '&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hi&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;'</div><div><br/></div><div>const server = http.createServer((req, res) =&gt; {</div><div>  res.writeHead(200, {</div><div>    // 'Content-Type': 'text/plain'</div><div>    'Content-Type': 'text/html'</div><div>  });</div><div>  res.end(html);</div><div>});</div><div><br/></div><div>server.listen(3000)</div><div><br/></div><div>————————————express</div><div>var express = require('express')</div><div>var app = express()</div><div /><div>app.get('/', function (req, res) {</div><div>  res.end('home')</div><div>})</div><div><br/></div><div>app.get('/users', function (req, res) {</div><div>  res.end('users')</div><div>})</div><div /><div>app.listen(3000)</div><div><br/></div><div>————————————路由</div><div>var express = require('express')</div><div>var app = express()</div><div /><div>app.get('/', function (req, res) {</div><div>  res.end('home')</div><div>})</div><div><br/></div><div>app.get('/users', function (req, res) {</div><div>  res.end('users')</div><div>})</div><div><br/></div><div>app.get('/users?', function (req, res) {</div><div>  res.set('content-type', 'text/plain; charset=utf-8')</div><div>  res.end('hi')</div><div>})</div><div><br/></div><div>app.get('/users+', function (req, res) {</div><div>  res.set('content-type', 'text/plain; charset=utf-8')</div><div>  res.end('hi')</div><div>})</div><div><br/></div><div>app.get('/users/*', function (req, res) {</div><div>  res.set('content-type', 'text/plain; charset=utf-8')</div><div>  res.end('users')</div><div>})</div><div><br/></div><div>app.get('/users/:uid/name', function (req, res) {</div><div>  res.set('content-type', 'text/plain; charset=utf-8')</div><div>  res.end('用户名是：' + req.params.uid)</div><div>})</div><div><br/></div><div>app.listen(3000)</div><div><br/></div><div>————————————中间件</div><div>var express = require('express')</div><div>var app = express()</div><div><br/></div><div>// function logger(req, res, next) {</div><div>//   console.log(req.method + ' ' + req.originalUrl)</div><div>//   next()</div><div>// }</div><div><br/></div><div>function logger2(req, res, next) {</div><div>  console.log(req.method + ' ' + req.originalUrl)</div><div>  res.end('hi')</div><div>}</div><div>// app.use(logger) // 应用级</div><div><br/></div><div>// app.get('/users/:user', logger, function (req, res) {// 路由级</div><div>//   res.end('user: ' + req.params.user)</div><div>// })</div><div>app.get('/users/:user', logger2, function (req, res) {// 路由级</div><div>  res.end('user: ' + req.params.user)</div><div>})</div><div><br/></div><div>app.listen(3000)</div><div>—————————————中间件顺序</div><div>var express = require('express')</div><div>var app = express()</div><div><br/></div><div>function logger(req, res, next) {</div><div>  console.log(1, req.method + ' ' + req.originalUrl)</div><div>  next()</div><div>}</div><div><br/></div><div>function logger2(req, res, next) {</div><div>  console.log(2, req.method + ' ' + req.originalUrl)</div><div>  next()</div><div>}</div><div>app.use(logger2)</div><div>app.use(logger)</div><div><br/></div><div>app.get('/users/:user', function (req, res) {</div><div>  res.end('user: ' + req.params.user)</div><div>})</div><div><br/></div><div>app.listen(3000)</div><div>————————————ejs</div><div><br/></div><div>var ejs = require('ejs')</div><div>var str = 'Hello, &lt;%= name %&gt;'// 字符串模板</div><div>var template = ejs.compile(str)</div><div><br/></div><div>console.log(template({ name: 'zhangsan' }))</div><div>———————————ejs2</div><div>var ejs = require('ejs')</div><div>var str = 'Hello, &lt;%= name %&gt;'// 字符串模板</div><div>var str2 = 'Hello, &lt;%- name %&gt;'// 字符串模板</div><div>var str3 = `Hello,</div><div>  &lt;% if (name !== "zhangsan") { %&gt;</div><div>    张三</div><div>  &lt;% } else { %&gt;</div><div>    李四</div><div>  &lt;% } %&gt;</div><div>`// 字符串模板</div><div>var str4 = `</div><div>  &lt;ul&gt;</div><div>    &lt;% names.forEach(function (name) { %&gt;</div><div>      &lt;li&gt;&lt;%= name %&gt;&lt;/li&gt;</div><div>    &lt;% }) %&gt;</div><div>  &lt;/ul&gt;</div><div>`</div><div>var str5 = `</div><div>  &lt;% for (var i = 0; i &lt; names.length; i++) { %&gt;</div><div>    &lt;%= i + 1 %&gt;. &lt;%= names[i] %&gt;</div><div>  &lt;% } %&gt;</div><div>`</div><div>var template = ejs.compile(str)</div><div>var template2 = ejs.compile(str2)</div><div>var template3 = ejs.compile(str3)</div><div>var template4 = ejs.compile(str4)</div><div>var template5 = ejs.compile(str5)</div><div><br/></div><div>console.log(template({ name: 'zhangsan' }))</div><div>console.log(template({ name: '&lt;p&gt;zhangsan&lt;/p&gt;' }))</div><div>console.log(template2({ name: '&lt;p&gt;zhangsan&lt;/p&gt;' }))</div><div>console.log(template3({ name: 'zhangsan' }))</div><div>console.log(template4({ names: ['zhangsan', 'lisi', 'haibing'] }))</div><div>console.log(template5({ names: ['zhangsan', 'lisi', 'haibing'] }))</div><div><br/></div><div>———————————error handler</div><div>var express = require('express')</div><div>var app = express()</div><div><br/></div><div>app.get(</div><div>  '/',</div><div>  function (req, res, next) {</div><div>    // throw new Error('error')</div><div>    next(new Error('error'))</div><div>    // next()</div><div>  },</div><div>  function (req, res, next) {</div><div>    console.log('normal')</div><div>    res.end('normal')</div><div>  }</div><div>)</div><div><br/></div><div>app.use(function (err, req, res, next) {</div><div>  console.log(err)</div><div>  res.status(500).send('Something broke!')</div><div>  // res.send('&lt;h1&gt;ERROR&lt;/h1&gt;')</div><div>})</div><div><br/></div><div>app.listen(3000)</div><div>——————————— 404</div><div>var express = require('express')</div><div>var app = express()</div><div><br/></div><div>app.get(</div><div>  '/',</div><div>  function (req, res, next) {</div><div>    // throw new Error('error')</div><div>    next(new Error('error'))</div><div>    // next()</div><div>  },</div><div>  function (req, res, next) {</div><div>    console.log('normal')</div><div>    res.end('normal')</div><div>  }</div><div>)</div><div><br/></div><div>// error handler</div><div>app.use(function (err, req, res, next) {</div><div>  console.log(err)</div><div>  res.status(500).send('Something broke!')</div><div>  // res.send('&lt;h1&gt;ERROR&lt;/h1&gt;')</div><div>})</div><div><br/></div><div>// 404</div><div>app.use(function (req, res, next) {</div><div>  res.send('&lt;html&gt;&lt;body&gt;&lt;script type="text/javascript" src="//qzonestyle.gtimg.cn/qzone/hybrid/app/404/search_children.js" charset="utf-8"&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;')</div><div>})</div><div><br/></div><div>app.listen(3000)</div><div><br/></div><div>——————————静态资源</div><div>var express = require('express')</div><div>var app = express()</div><div><br/></div><div>app.use('/public', express.static('public'))</div><div>app.get('/public/*', function (req, res) {</div><div>  res.end(req.originalUrl)</div><div>})</div><div><br/></div><div>app.listen(3000)</div><div><br/></div><div><br/></div><div><br/></div><div>var express = require('express')</div><div>var app = express()</div><div><br/></div><div>var html = `</div><div>  &lt;html&gt;</div><div>    &lt;body&gt;</div><div>      &lt;img src="/public/avatar.png"/&gt;</div><div>    &lt;/body&gt;</div><div>  &lt;/html&gt;</div><div>`</div><div><br/></div><div>app.use('/public', express.static('public'))</div><div>app.get('/', function (req, res) {</div><div>  res.send(html)</div><div>})</div><div><br/></div><div>app.listen(3000)</div></body></html>